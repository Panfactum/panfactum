FROM node:18-bullseye-slim as builder

RUN npm i -g pnpm@8.6.12

WORKDIR /code
COPY package.json pnpm-lock.yaml .npmrc pnpm-workspace.yaml .
COPY packages/public-site/package.json packages/public-site/pnpm-lock.yaml packages/public-site/
RUN --mount=type=cache,target=/code/.pnp pnpm install --frozen-lockfile
COPY packages/public-site/ packages/public-site/
WORKDIR /code/packages/public-site
RUN pnpm build


FROM nginx:1.25.1 as production
WORKDIR /build
COPY packages/nginx/nginx.conf /etc/nginx/nginx.conf
COPY --from=builder /code/packages/public-site/build /build

