FROM node:18-bullseye-slim as development

# Install package manager
RUN npm i -g pnpm@8.6.12

# Install Dependencies
WORKDIR /code
COPY package.json pnpm-lock.yaml .npmrc pnpm-workspace.yaml .
COPY packages/public-app/package.json packages/public-app/pnpm-lock.yaml packages/public-app/
COPY packages/eslint/ packages/eslint/
COPY packages/build/ packages/build/
COPY packages/primary-api/ packages/primary-api/
RUN --mount=type=cache,target=/code/.pnp pnpm install --frozen-lockfile

# Build
COPY packages/public-app/ packages/public-app/
WORKDIR packages/public-app

FROM development as production
COPY packages/public-app/scripts/start.sh start.sh
ENTRYPOINT ["/code/packages/public-app/start.sh"]
RUN npx next build

# TODO: Create an actual production build without all the dev dependencies
